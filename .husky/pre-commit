#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# TypeScriptå‹ãƒã‚§ãƒƒã‚¯
npm run type-check

# lint-stagedå®Ÿè¡Œï¼ˆESLint + Prettierï¼‰
npx lint-staged

# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œæŸ»ã—ã¦E2Eãƒ†ã‚¹ãƒˆã®å¿…è¦æ€§ã‚’åˆ¤å®š
check_if_e2e_needed() {
    # git diffã§ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
    changed_files=$(git diff --cached --name-only)

    # å¤‰æ›´ãŒãªã„å ´åˆã¯E2Eä¸è¦
    if [ -z "$changed_files" ]; then
        return 1
    fi

    # .cursorã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä»¥å¤–ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    non_cursor_changes=$(echo "$changed_files" | grep -v "^\.cursor" || true)

    # .cursorä»¥å¤–ã®å¤‰æ›´ãŒã‚ã‚Œã°E2Eå¿…è¦
    if [ -n "$non_cursor_changes" ]; then
        return 0
    else
        return 1
    fi
}

# E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œåˆ¤å®š
if [ "$SKIP_E2E" = "1" ]; then
    echo "âš ï¸ E2Eãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ (SKIP_E2E=1)"
elif ! check_if_e2e_needed; then
    echo "ğŸ”„ .cursorã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ã®å¤‰æ›´ã®ãŸã‚ã€E2Eãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—"
else
    echo "ğŸ§ª é‡è¦æ©Ÿèƒ½E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
    # å®‰å®šã—ãŸãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œï¼ˆèªè¨¼ + æœç”¨è¨˜éŒ²å›å¸°ã®ã¿ï¼‰
    npx playwright test tests/e2e/auth tests/e2e/regression/dosage-tracking.spec.ts --project=chromium || {
        echo "âŒ E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
        echo "ğŸ’¡ ç·Šæ€¥æ™‚ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¹ã‚­ãƒƒãƒ—ã§ãã¾ã™:"
        echo "   SKIP_E2E=1 git commit -m \"ç·Šæ€¥ä¿®æ­£\""
        exit 1
    }
fi

echo "âœ… ã™ã¹ã¦ã®pre-commitãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"
