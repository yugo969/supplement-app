#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# TypeScriptå‹ãƒã‚§ãƒƒã‚¯
npm run type-check

# lint-stagedå®Ÿè¡Œï¼ˆESLint + Prettierï¼‰
npx lint-staged

# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œæŸ»ã—ã¦E2Eãƒ†ã‚¹ãƒˆã®å¿…è¦æ€§ã‚’åˆ¤å®š
check_if_e2e_needed() {
    # git diffã§ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
    changed_files=$(git diff --cached --name-only)

    # å¤‰æ›´ãŒãªã„å ´åˆã¯E2Eä¸è¦
    if [ -z "$changed_files" ]; then
        return 1
    fi

    # .cursorã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä»¥å¤–ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    non_cursor_changes=$(echo "$changed_files" | grep -v "^\.cursor" || true)

    # .cursorä»¥å¤–ã®å¤‰æ›´ãŒã‚ã‚Œã°E2Eå¿…è¦
    if [ -n "$non_cursor_changes" ]; then
        return 0
    else
        return 1
    fi
}

# E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œåˆ¤å®š
if [ "$SKIP_E2E" = "1" ]; then
    echo "âš ï¸ E2Eãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ (SKIP_E2E=1)"
elif ! check_if_e2e_needed; then
    echo "ğŸ”„ .cursorã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ã®å¤‰æ›´ã®ãŸã‚ã€E2Eãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—"
else
    echo "ğŸ§ª é‡è¦æ©Ÿèƒ½E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
    # pre-commitã¯å¤–éƒ¨èªè¨¼ã®æˆå¦ã«ä¾å­˜ã—ãªã„smokeã®ã¿å®Ÿè¡Œã™ã‚‹ã€‚
    # èªè¨¼æˆåŠŸ/æœç”¨è¨˜éŒ²ã®é‡ã„å›å¸°ã¯CIã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œã«å§”è­²ã™ã‚‹ã€‚
    run_smoke() {
      target_port="$1"
      echo "ğŸ” pre-commit smoke (E2E_PORT=$target_port)"
      E2E_PORT="$target_port" npx playwright test \
        tests/e2e/smoke/precommit-smoke.spec.ts \
        --project=chromium \
        --workers=1 \
        --retries=0
    }

    smoke_ok=0
    if [ -n "$E2E_PORT" ]; then
      run_smoke "$E2E_PORT" && smoke_ok=1
    else
      for port in 3001 3002 3000; do
        if run_smoke "$port"; then
          smoke_ok=1
          break
        fi
      done
    fi

    [ "$smoke_ok" -eq 1 ] || {
        echo "âŒ E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
        echo "ğŸ’¡ å®Ÿè¡Œæ¸ˆã¿ãƒãƒ¼ãƒˆ: ${E2E_PORT:-3001,3002,3000}"
        echo "ğŸ’¡ ç·Šæ€¥æ™‚ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¹ã‚­ãƒƒãƒ—ã§ãã¾ã™:"
        echo "   SKIP_E2E=1 git commit -m \"ç·Šæ€¥ä¿®æ­£\""
        exit 1
    }
fi

echo "âœ… ã™ã¹ã¦ã®pre-commitãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"
