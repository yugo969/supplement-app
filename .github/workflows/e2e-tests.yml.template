name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      test_scope:
        description: "Test scope to run"
        required: false
        default: "critical"
        type: choice
        options:
          - critical
          - full

jobs:
  # PRç”¨ï¼šé‡è¦ãƒ†ã‚¹ãƒˆã®ã¿ï¼ˆé«˜é€Ÿï¼‰
  e2e-critical:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_scope == 'critical')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers (Chromium only)
        run: npx playwright install --with-deps chromium

      - name: Build Next.js application
        run: npm run build

      - name: Run critical E2E tests
        run: npx playwright test tests/e2e/auth tests/e2e/supplements tests/e2e/regression/dosage-tracking.spec.ts --project=chromium
        env:
          # Firebase ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®š
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          # ãƒ†ã‚¹ãƒˆç”¨èªè¨¼æƒ…å ±
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-critical-report
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  # mainãƒ–ãƒ©ãƒ³ãƒç”¨ï¼šå…¨ãƒ†ã‚¹ãƒˆï¼ˆå¾¹åº•çš„ï¼‰
  e2e-full:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_scope == 'full')

    strategy:
      fail-fast: false
      matrix:
        # ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆæ™‚ã®ã¿è¤‡æ•°ãƒ–ãƒ©ã‚¦ã‚¶
        browser: [chromium, firefox] # webkitã¯å‰Šé™¤ï¼ˆä¸å®‰å®šãªãŸã‚ï¼‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Build Next.js application
        run: npm run build

      - name: Run full E2E tests
        run: npm run test:e2e -- --project=${{ matrix.browser }}
        env:
          # Firebase ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®š
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          # ãƒ†ã‚¹ãƒˆç”¨èªè¨¼æƒ…å ±
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-full-report-${{ matrix.browser }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30

      - name: Upload failure screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-screenshots-${{ matrix.browser }}
          path: test-results/**/*-failed-*.png
          retention-days: 7

  # ãƒ†ã‚¹ãƒˆçµæœã®ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
  test-summary:
    runs-on: ubuntu-latest
    needs: [e2e-critical, e2e-full]
    if: always() && (needs.e2e-critical.result != 'skipped' || needs.e2e-full.result != 'skipped')

    steps:
      - name: Generate test summary
        run: |
          echo "# ğŸ§ª E2E Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.e2e-critical.result }}" != "skipped" ]]; then
            echo "## âš¡ Critical Tests (PRå‘ã‘é«˜é€Ÿãƒ†ã‚¹ãƒˆ)" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ needs.e2e-critical.result }}" == "success" ]]; then
              echo "âœ… **èªè¨¼ãƒ»CRUDãƒ»æœç”¨è¨˜éŒ²ãƒ†ã‚¹ãƒˆ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **èªè¨¼ãƒ»CRUDãƒ»æœç”¨è¨˜éŒ²ãƒ†ã‚¹ãƒˆ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            fi
            echo "- **å®Ÿè¡Œæ™‚é–“**: ~5åˆ†" >> $GITHUB_STEP_SUMMARY
            echo "- **ãƒ–ãƒ©ã‚¦ã‚¶**: Chromium ã®ã¿" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.e2e-full.result }}" != "skipped" ]]; then
            echo "## ğŸ”„ Full Tests (main/developå‘ã‘åŒ…æ‹¬ãƒ†ã‚¹ãƒˆ)" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ needs.e2e-full.result }}" == "success" ]]; then
              echo "âœ… **å…¨99ãƒ†ã‚¹ãƒˆ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **å…¨99ãƒ†ã‚¹ãƒˆ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            fi
            echo "- **å®Ÿè¡Œæ™‚é–“**: ~20åˆ†" >> $GITHUB_STEP_SUMMARY
            echo "- **ãƒ–ãƒ©ã‚¦ã‚¶**: Chromium + Firefox" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "## ğŸ’¡ ãƒ†ã‚¹ãƒˆæˆ¦ç•¥" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: é‡è¦æ©Ÿèƒ½ã®ã¿é«˜é€Ÿãƒ†ã‚¹ãƒˆï¼ˆ5åˆ†ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- **main/develop**: å…¨æ©Ÿèƒ½åŒ…æ‹¬ãƒ†ã‚¹ãƒˆï¼ˆ20åˆ†ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰‹å‹•å®Ÿè¡Œ**: å¿…è¦ã«å¿œã˜ã¦é¸æŠå¯èƒ½" >> $GITHUB_STEP_SUMMARY

  # å¤±æ•—æ™‚ã®ç·Šæ€¥é€šçŸ¥
  failure-notification:
    runs-on: ubuntu-latest
    needs: [e2e-critical, e2e-full]
    if: failure()

    steps:
      - name: Notify on critical failure
        run: |
          if [[ "${{ needs.e2e-critical.result }}" == "failure" ]]; then
            echo "::error::ğŸš¨ é‡è¦æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚PRãƒãƒ¼ã‚¸ã‚’åœæ­¢ã—ã€ä¿®æ­£ã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚"
          fi
          if [[ "${{ needs.e2e-full.result }}" == "failure" ]]; then
            echo "::warning::âš ï¸ åŒ…æ‹¬ãƒ†ã‚¹ãƒˆã§å•é¡ŒãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸã€‚ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ä½œæ¥­å‰ã«ç¢ºèªãŒå¿…è¦ã§ã™ã€‚"
          fi
