name: Deploy to Netlify (Production)

on:
  push:
    branches:
      - main # æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
  pull_request:
    branches:
      - main # PRç”¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: "Deploy environment"
        required: false
        default: "preview"
        type: choice
        options:
          - preview
          - production

jobs:
  deploy-to-netlify:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é™¤å¤–ã—ã¦ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository (no submodules)
        uses: actions/checkout@v4
        with:
          submodules: "false" # ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å–å¾—ã—ãªã„

      # .gitmodulesã‹ã‚‰.cursorã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é™¤å¤–
      - name: Remove .cursor submodule from .gitmodules
        run: |
          if [ -f .gitmodules ]; then
            echo "ðŸ“ Original .gitmodules content:"
            cat .gitmodules
            echo "âœ‚ï¸ Removing .cursor submodule from .gitmodules..."

            # .cursorã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
            sed -i '/^\[submodule "\.cursor"\]/,/^$/d' .gitmodules

            echo "âœ… Modified .gitmodules content:"
            cat .gitmodules

            # ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã«ãªã£ãŸå ´åˆã¯å‰Šé™¤
            if [ ! -s .gitmodules ]; then
              echo "ðŸ—‘ï¸ .gitmodules is empty, removing file..."
              rm .gitmodules
            fi
          else
            echo "â„¹ï¸ No .gitmodules file found."
          fi

      # Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18.x"
          cache: "npm"

      # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm ci

      # TypeScriptåž‹ãƒã‚§ãƒƒã‚¯
      - name: Type check
        run: npm run build
        env:
          # Firebaseç’°å¢ƒè¨­å®šï¼ˆæœ¬ç•ªç”¨ï¼‰
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}

      # ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã®ç¢ºèª
      - name: Verify build output
        run: |
          echo "ðŸ“¦ Build output structure:"
          ls -la .next/
          echo "ðŸ“Š Build size summary:"
          du -sh .next/

      # Netlifyã¸ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: "./.next"
          production-deploy: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: |
            Deploy from GitHub Actions
            Commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}
            Trigger: ${{ github.event_name }}
          enable-pull-request-comment: true
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 10

      # ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã®ã‚µãƒžãƒªãƒ¼
      - name: Deployment summary
        run: |
          echo "# ðŸš€ Netlify Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'Production' || 'Preview' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Quality Assurance" >> $GITHUB_STEP_SUMMARY
          echo "- **Submodule Handling**: .cursor development config excluded from production" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Verification**: TypeScript compilation successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Firebase Integration**: Environment variables configured" >> $GITHUB_STEP_SUMMARY
          echo "- **Production Ready**: Clean deployment without development dependencies" >> $GITHUB_STEP_SUMMARY
