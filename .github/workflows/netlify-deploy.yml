name: Deploy to Netlify

on:
  push:
    branches:
      - main # æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
  pull_request:
    branches:
      - main # PRç”¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: "Deploy environment"
        required: false
        default: "preview"
        type: choice
        options:
          - preview
          - production

jobs:
  deploy-to-netlify:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY || vars.FIREBASE_API_KEY || secrets.NEXT_PUBLIC_FIREBASE_API_KEY || vars.NEXT_PUBLIC_FIREBASE_API_KEY }}
      NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN || vars.FIREBASE_AUTH_DOMAIN || secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN || vars.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
      NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID || vars.FIREBASE_PROJECT_ID || secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID || vars.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
      NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET || vars.FIREBASE_STORAGE_BUCKET || secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET || vars.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
      NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID || vars.FIREBASE_MESSAGING_SENDER_ID || secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID || vars.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
      NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID || vars.FIREBASE_APP_ID || secrets.NEXT_PUBLIC_FIREBASE_APP_ID || vars.NEXT_PUBLIC_FIREBASE_APP_ID }}

    steps:
      # ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é™¤å¤–ã—ã¦ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository (no submodules)
        uses: actions/checkout@v4
        with:
          submodules: "false" # ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å–å¾—ã—ãªã„

      # .gitmodulesã‹ã‚‰.cursorã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é™¤å¤–
      - name: Remove .cursor submodule from .gitmodules
        run: |
          if [ -f .gitmodules ]; then
            echo "ðŸ“ Original .gitmodules content:"
            cat .gitmodules
            echo "âœ‚ï¸ Removing .cursor submodule from .gitmodules..."

            # .cursorã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
            sed -i '/^\[submodule "\.cursor"\]/,/^$/d' .gitmodules

            echo "âœ… Modified .gitmodules content:"
            cat .gitmodules

            # ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã«ãªã£ãŸå ´åˆã¯å‰Šé™¤
            if [ ! -s .gitmodules ]; then
              echo "ðŸ—‘ï¸ .gitmodules is empty, removing file..."
              rm .gitmodules
            fi
          else
            echo "â„¹ï¸ No .gitmodules file found."
          fi

      # Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18.x"
          cache: "npm"

      # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm ci

      # TypeScriptåž‹ãƒã‚§ãƒƒã‚¯
      - name: Build (Next.js)
        run: npm run build

      - name: Netlify CLI preflight
        run: |
          set -euo pipefail
          [ -n "${NEXT_PUBLIC_FIREBASE_API_KEY:-}" ] || { echo "::error::Missing Firebase env: NEXT_PUBLIC_FIREBASE_API_KEY"; exit 1; }
          [ -n "${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN:-}" ] || { echo "::error::Missing Firebase env: NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN"; exit 1; }
          [ -n "${NEXT_PUBLIC_FIREBASE_PROJECT_ID:-}" ] || { echo "::error::Missing Firebase env: NEXT_PUBLIC_FIREBASE_PROJECT_ID"; exit 1; }
          [ -n "${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET:-}" ] || { echo "::error::Missing Firebase env: NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET"; exit 1; }
          [ -n "${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID:-}" ] || { echo "::error::Missing Firebase env: NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID"; exit 1; }
          [ -n "${NEXT_PUBLIC_FIREBASE_APP_ID:-}" ] || { echo "::error::Missing Firebase env: NEXT_PUBLIC_FIREBASE_APP_ID"; exit 1; }
          npx --yes netlify@23.15.1 --version
          npx --yes netlify@23.15.1 api getSite \
            --auth "$NETLIFY_AUTH_TOKEN" \
            --data "{\"site_id\":\"$NETLIFY_SITE_ID\"}" >/dev/null
          echo "Netlify preflight passed."

      - name: Netlify build (PR)
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          npx --yes netlify@23.15.1 build \
            --auth "$NETLIFY_AUTH_TOKEN" \
            --context deploy-preview

      - name: Netlify build (main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          npx --yes netlify@23.15.1 build \
            --auth "$NETLIFY_AUTH_TOKEN" \
            --context production

      - name: Deploy Preview to Netlify (PR)
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          DEPLOY_STDOUT="$(mktemp)"
          DEPLOY_STDERR="$(mktemp)"
          set +e
          npx --yes netlify@23.15.1 deploy \
            --auth "$NETLIFY_AUTH_TOKEN" \
            --site "$NETLIFY_SITE_ID" \
            --alias "pr-${{ github.event.pull_request.number }}" \
            --message "PR #${{ github.event.pull_request.number }} / ${{ github.sha }}" \
            --no-build \
            --json >"$DEPLOY_STDOUT" 2>"$DEPLOY_STDERR"
          status=$?
          set -e
          if [ "$status" -ne 0 ]; then
            echo "::error::Netlify preview deploy failed (exit code: $status)"
            echo "---- netlify stderr ----"
            cat "$DEPLOY_STDERR" || true
            echo "---- netlify stdout ----"
            cat "$DEPLOY_STDOUT" || true
            exit "$status"
          fi
          cat "$DEPLOY_STDOUT"
          cp "$DEPLOY_STDOUT" netlify-deploy.json

      - name: Deploy Production to Netlify (main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          DEPLOY_STDOUT="$(mktemp)"
          DEPLOY_STDERR="$(mktemp)"
          set +e
          npx --yes netlify@23.15.1 deploy \
            --auth "$NETLIFY_AUTH_TOKEN" \
            --site "$NETLIFY_SITE_ID" \
            --prod \
            --message "main / ${{ github.sha }}" \
            --no-build \
            --json >"$DEPLOY_STDOUT" 2>"$DEPLOY_STDERR"
          status=$?
          set -e
          if [ "$status" -ne 0 ]; then
            echo "::error::Netlify production deploy failed (exit code: $status)"
            echo "---- netlify stderr ----"
            cat "$DEPLOY_STDERR" || true
            echo "---- netlify stdout ----"
            cat "$DEPLOY_STDOUT" || true
            exit "$status"
          fi
          cat "$DEPLOY_STDOUT"
          cp "$DEPLOY_STDOUT" netlify-deploy.json

      # ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã®ã‚µãƒžãƒªãƒ¼
      - name: Deployment summary
        run: |
          echo "# ðŸš€ Netlify Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'Production' || 'Preview' }}" >> $GITHUB_STEP_SUMMARY
          if [ -s netlify-deploy.json ]; then
            deploy_url=$(node -e "const fs=require('fs');try{const d=JSON.parse(fs.readFileSync('netlify-deploy.json','utf8'));console.log(d.deploy_url||'')}catch(e){console.log('')}")
            logs_url=$(node -e "const fs=require('fs');try{const d=JSON.parse(fs.readFileSync('netlify-deploy.json','utf8'));console.log(d.logs||'')}catch(e){console.log('')}")
            [ -n "$deploy_url" ] && echo "- **Deploy URL**: $deploy_url" >> $GITHUB_STEP_SUMMARY
            [ -n "$logs_url" ] && echo "- **Logs URL**: $logs_url" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Deploy URL**: (not available)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Quality Assurance" >> $GITHUB_STEP_SUMMARY
          echo "- **Submodule Handling**: .cursor development config excluded from production" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Verification**: Next.js build successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Firebase Integration**: Environment variables configured" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Strategy**: PR=Deploy Preview / main=Production" >> $GITHUB_STEP_SUMMARY
